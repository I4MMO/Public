local create = consolecreate or rconsolecreate 
local settitle = consolesettitle or rconsolesettitle
local consoleclear = consoleclear or rconsoleclear
local consoleprint = consoleprint or rconsoleprint

local clonefunction = clonefunction or function(f) return f end
local makestring = clonefunction(tostring)
local caller = clonefunction(checkcaller)
local typeof = clonefunction(typeof)
      consoleprint = clonefunction(consoleprint)
local Request = clonefunction(request)
local HttpRequest = clonefunction(http.request)
local HttpGet = clonefunction(game.HttpGet)
local HttpGetAsync = clonefunction(game.HttpGetAsync)
local getnamecallmethod = clonefunction(getnamecallmethod)
local select = clonefunction(select)
local pairs = clonefunction(pairs)
local match = clonefunction(string.match)

local date = clonefunction(os.date)
local time = clonefunction(os.time)

local freeze = function(state,tbl)
    if state then 
        local lock = makereadonly or setreadonly
        return lock(tbl,state)
    end 

    local unlock = makewriteable or setreadonly

    return unlock(tbl,state)
        

end 

create()
settitle("Http Spy")
consoleclear()


local OutputInfo = function(...)
    local args = {...}
    local str = makestring(date("%H:%M", time())) .. " "
    for i, v in pairs(args) do
        str = str .. makestring(v) .. " "
    end
    consoleprint(str.. "\n")
end

local IsString = function(value)
    return typeof(value) == "string"
end

local IsUrl = function(value)
    return match(value, "^https?://") ~= nil
end

local ValidSize = function(value)
    return #value < 500
end 

getgenv().request = newcclosure(function(...)
    local Req = ... 
    if Req.Url and IsString(Req.Url) and IsUrl(Req.Url) and ValidSize(Req.Url) then 
        OutputInfo("Requested URL:", Req.Url)
    end

    return Request(...)
end)

freeze(false,http)

http.request = newcclosure(function(...)
    local Req = ... 

    if Req.Url and IsString(Req.Url) and IsUrl(Req.Url) and ValidSize(Req.Url) then 
        OutputInfo("Http Requested URL:", Req.Url)
    end

    return HttpRequest(...)
end)

freeze(true,http)

local NewHttpGet = newcclosure(function(self,url,...)
    if url and IsString(url) and IsUrl(url) and ValidSize(url) then 
        OutputInfo("HttpGet URL:", url)
    end

    return HttpGet(self,url,...)
end)

local NewHttpGetAsync = newcclosure(function(self,url,...)
    if url and IsString(url) and IsUrl(url) and ValidSize(url) then 
        OutputInfo("HttpGetAsync URL:", url)
    end

    return HttpGetAsync(self,url,...)
end)

local Methods = {
    ["HttpGet"] = NewHttpGet,
    ["HttpGetAsync"] = NewHttpGetAsync,
}

local RequestFunctions = {
    request,
    http.request,
}


if setname then 
    for i , v in pairs(Methods) do 
        setname(v, i)
    end 
    for _ , v in pairs(RequestFunctions) do 
        setname(v,"request")
    end 
end 

local Index; Index = hookmetamethod(game, "__index", newcclosure(function(...)
    if caller() then 
        local self, key = ...

        if self == game then 
            local method = Methods[key]
            if method then 
                return method
            end

        end 
    end 
    return Index(...)
end))

local Namecall; Namecall = hookmetamethod(game, "__namecall", newcclosure(function(...)
    if caller() then 
        local self = select(1,...)
        local method = getnamecallmethod()
        if self == game then
            local IsValidMethod = Methods[method]
            if IsValidMethod then 
                local url = select(2,...)
                if url and IsString(url) and IsUrl(url) and ValidSize(url) then 
                    OutputInfo(method, "URL:", url)
                end 
            end 
        end 
    end
    return Namecall(...)
end))

OutputInfo("Http Spy Loaded")
